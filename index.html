<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸à¸à¸«à¸¡à¸²à¸¢à¹„à¸—à¸¢ - Thai Law Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .chat-bubble-user {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem;
        }
        .chat-bubble-ai {
            background-color: #ffffff;
            color: #1f2937; /* Gray-800 */
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl flex flex-col h-[90vh]">
        
        <!-- Header -->
        <header class="p-4 border-b bg-gray-50 rounded-t-xl flex justify-between items-center shadow-md">
            <h1 id="app-title" class="text-2xl font-bold text-gray-800">à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸à¸à¸«à¸¡à¸²à¸¢à¹„à¸—à¸¢</h1>
            
            <!-- Language Selector -->
            <div class="flex items-center space-x-2">
                <label for="language-select" class="text-sm font-medium text-gray-600 hidden sm:block">à¸ à¸²à¸©à¸²:</label>
                <select id="language-select" class="p-2 rounded-lg border border-gray-300 bg-white shadow-inner focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out cursor-pointer text-sm">
                    <option value="thai">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢ (Thai)</option>
                    <option value="english">ğŸ‡ºğŸ‡¸ English</option>
                    <option value="chinese">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡ (Simplified Chinese)</option>
                </select>
            </div>
        </header>

        <!-- Chat History (Initial greeting will be injected by JavaScript) -->
        <main id="chat-history" class="flex-grow overflow-y-auto p-6 space-y-4">
            <!-- Messages will be injected here -->
        </main>

        <!-- Input Area -->
        <footer class="p-4 border-t bg-gray-50 rounded-b-xl">
            <div class="flex space-x-3">
                <input
                    type="text"
                    id="user-input"
                    class="flex-grow p-3 border border-gray-300 rounded-xl shadow-inner focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                    placeholder="à¸à¸´à¸¡à¸à¹Œà¸„à¸³à¸–à¸²à¸¡à¸—à¸²à¸‡à¸à¸à¸«à¸¡à¸²à¸¢à¸‚à¸­à¸‡à¸„à¸¸à¸“..."
                    autocomplete="off"
                >
                <button
                    id="send-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-105 disabled:bg-gray-400 disabled:shadow-none"
                >
                    à¸ªà¹ˆà¸‡
                </button>
            </div>
        </footer>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-3">
            <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-text" class="text-gray-700 font-medium">à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥...</span>
        </div>
    </div>


    <script>
        // --- Configuration and Constants ---
        // New URL points to the Netlify serverless function
        const PROXY_API_URL = "/.netlify/functions/gemini-proxy";
        
        // --- UI Element References ---
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const languageSelect = document.getElementById('language-select');
        const appTitle = document.getElementById('app-title');
        const loadingModal = document.getElementById('loading-modal');
        const loadingText = document.getElementById('loading-text');

        // Note: API Key is no longer accessed here; it is secure in the Netlify function.

        // --- Language Mapping ---
        const LANGUAGES = {
            'thai': {
                code: 'Thai',
                title: 'à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸à¸à¸«à¸¡à¸²à¸¢à¹„à¸—à¸¢',
                placeholder: 'à¸à¸´à¸¡à¸à¹Œà¸„à¸³à¸–à¸²à¸¡à¸—à¸²à¸‡à¸à¸à¸«à¸¡à¸²à¸¢à¸‚à¸­à¸‡à¸„à¸¸à¸“...',
                sendButton: 'à¸ªà¹ˆà¸‡',
                loading: 'à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥...',
                greeting: "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¹ˆà¸° à¸”à¸´à¸‰à¸±à¸™à¸„à¸·à¸­à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸à¸à¸«à¸¡à¸²à¸¢à¹„à¸—à¸¢ à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸”à¹‰à¸²à¸™à¸à¸à¸«à¸¡à¸²à¸¢à¹„à¸—à¸¢à¸—à¸µà¹ˆà¸à¸£à¹‰à¸­à¸¡à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸¥à¸°à¸„à¸³à¹à¸™à¸°à¸™à¸³à¹€à¸šà¸·à¹‰à¸­à¸‡à¸•à¹‰à¸™à¸„à¹ˆà¸° à¸—à¹ˆà¸²à¸™à¸¡à¸µà¸„à¸³à¸–à¸²à¸¡à¹ƒà¸”à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸à¸à¸«à¸¡à¸²à¸¢à¹„à¸—à¸¢à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸„à¸°?",
                // System Prompt is passed to the secure proxy
                systemPrompt: "à¸„à¸¸à¸“à¸„à¸·à¸­à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸à¸à¸«à¸¡à¸²à¸¢ AI à¸œà¸¹à¹‰à¹€à¸Šà¸µà¹ˆà¸¢à¸§à¸Šà¸²à¸à¸—à¸µà¹ˆà¸¡à¸¸à¹ˆà¸‡à¹€à¸™à¹‰à¸™à¹€à¸‰à¸à¸²à¸°à¸à¸à¸«à¸¡à¸²à¸¢à¸‚à¸­à¸‡à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸ªà¸±à¸™à¸™à¸´à¸©à¸à¸²à¸™à¸§à¹ˆà¸²à¸„à¸³à¸–à¸²à¸¡à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸šà¹€à¸‚à¸•à¸­à¸³à¸™à¸²à¸ˆà¸¨à¸²à¸¥à¹„à¸—à¸¢à¹‚à¸”à¸¢à¹€à¸‰à¸à¸²à¸° à¹à¸¥à¸°à¸•à¹‰à¸­à¸‡à¸•à¸­à¸šà¸•à¸²à¸¡à¸à¸à¸«à¸¡à¸²à¸¢à¹„à¸—à¸¢à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸«à¸²à¸à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹ƒà¸”à¸ à¸²à¸¢à¹ƒà¸•à¹‰à¸à¸à¸«à¸¡à¸²à¸¢à¹„à¸—à¸¢à¹„à¸”à¹‰ à¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸£à¸°à¸šà¸¸à¸­à¸¢à¹ˆà¸²à¸‡à¸Šà¸±à¸”à¹€à¸ˆà¸™à¸§à¹ˆà¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸£à¹‰à¸­à¸‡à¸‚à¸­à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹ƒà¸Šà¹‰à¹„à¸”à¹‰à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆà¸¡à¸µà¹ƒà¸™à¸à¸à¸«à¸¡à¸²à¸¢à¹„à¸—à¸¢ à¸«à¹‰à¸²à¸¡à¹ƒà¸«à¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‚à¸­à¸‡à¸›à¸£à¸°à¹€à¸—à¸¨à¸­à¸·à¹ˆà¸™à¹‚à¸”à¸¢à¹€à¸”à¹‡à¸”à¸‚à¸²à¸” à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸”à¹‰à¸§à¸¢à¸„à¸§à¸²à¸¡à¹à¸¡à¹ˆà¸™à¸¢à¸³ à¹à¸¥à¸°à¹ƒà¸Šà¹‰à¸œà¸¥à¸à¸²à¸£à¸„à¹‰à¸™à¸«à¸²à¹€à¸à¸·à¹ˆà¸­à¸¢à¸·à¸™à¸¢à¸±à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ à¸à¸²à¸£à¸•à¸­à¸šà¸à¸¥à¸±à¸šà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¸—à¸µà¹ˆà¸Šà¸±à¸”à¹€à¸ˆà¸™à¹à¸¥à¸°à¹€à¸›à¹‡à¸™à¸¡à¸·à¸­à¸­à¸²à¸Šà¸µà¸",
                error_general: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¹ˆà¸° à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸šà¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ (Netlify) à¹‚à¸›à¸£à¸”à¸¥à¸­à¸‡à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡."
            },
            'english': {
                code: 'English',
                title: 'Thai Law Assistant',
                placeholder: 'Ask your legal question about Thai Law...',
                sendButton: 'Send',
                loading: 'Processing...',
                greeting: "Hello! I am the Thai Law Assistant, an expert in Thai law ready to provide information and initial guidance. Do you have any questions regarding Thai law?",
                // System Prompt is passed to the secure proxy
                systemPrompt: "You are a highly specialized AI Legal Analyst focusing ONLY on Thailand's laws. Assume all user questions refer exclusively to Thai jurisdiction and must be answered solely based on Thai law. If a question cannot be answered under Thai law, you MUST explicitly state that the requested information is not applicable or not available under Thai law, and DO NOT provide information from any other country. Respond with accuracy, utilizing search results for grounding. Your entire response must be generated clearly and professionally in the English language.",
                error_general: "Sorry, a connection error occurred with the server (Netlify). Please try again."
            },
            'chinese': {
                code: 'Simplified Chinese',
                title: 'æ³°å›½æ³•å¾‹åŠ©ç†',
                placeholder: 'è¾“å…¥æ‚¨çš„æ³•å¾‹é—®é¢˜...',
                sendButton: 'å‘é€',
                loading: 'æ­£åœ¨å¤„ç†...',
                greeting: "æ‚¨å¥½ï¼æˆ‘æ˜¯æ³°å›½æ³•å¾‹åŠ©ç†ï¼Œä¸€ä½æ³°æ³•å¾‹ä¸“å®¶ï¼Œéšæ—¶å‡†å¤‡ä¸ºæ‚¨æä¾›ä¿¡æ¯å’Œåˆæ­¥æŒ‡å¯¼ã€‚æ‚¨å¯¹æ³°å›½æ³•å¾‹æœ‰ä»€ä¹ˆç–‘é—®å—ï¼Ÿ",
                // System Prompt is passed to the secure proxy
                systemPrompt: "æ‚¨æ˜¯ä¸€ä½é«˜åº¦ä¸“ä¸šåŒ–çš„AIæ³•å¾‹åˆ†æå¸ˆï¼Œåªä¸“æ³¨äºæ³°å›½æ³•å¾‹ã€‚å‡è®¾æ‰€æœ‰ç”¨æˆ·é—®é¢˜éƒ½å®Œå…¨å±äºæ³°å›½å¸æ³•ç®¡è¾–åŒºï¼Œå¹¶ä¸”å¿…é¡»ä»…åŸºäºæ³°å›½æ³•å¾‹è¿›è¡Œå›ç­”ã€‚å¦‚æœæŸä¸ªé—®é¢˜æ— æ³•æ ¹æ®æ³°å›½æ³•å¾‹å›ç­”ï¼Œæ‚¨å¿…é¡»æ˜ç¡®å£°æ˜æ‰€è¯·æ±‚çš„ä¿¡æ¯ä¸é€‚ç”¨äºæ³°å›½æ³•å¾‹æˆ–åœ¨æ³°å›½æ³•å¾‹ä¸­ä¸å¯ç”¨ï¼Œä¸å¾—æä¾›ä»»ä½•å…¶ä»–å›½å®¶çš„ä¿¡æ¯ã€‚è¯·åˆ©ç”¨æœç´¢ç»“æœè¿›è¡ŒæŸ¥è¯ï¼Œå¹¶ä»¥æ¸…æ™°ä¸“ä¸šçš„ç®€ä½“ä¸­æ–‡ç”Ÿæˆæ‚¨çš„å…¨éƒ¨å›å¤ã€‚",
                error_general: "å¯¹ä¸èµ·ï¼Œä¸æœåŠ¡å™¨ (Netlify) è¿æ¥æ—¶å‘ç”Ÿé”™è¯¯ã€‚è¯·å†è¯•ä¸€æ¬¡ã€‚"
            }
        };

        let currentLanguage = languageSelect.value;
        let chatHistoryArray = [];

        // --- Core Functions ---

        /**
         * Clears chat history and displays the initial greeting for the selected language.
         */
        function displayInitialGreeting() {
            chatHistory.innerHTML = ''; 
            const lang = LANGUAGES[currentLanguage]; 
            // The greeting is intentionally not added to the chatHistoryArray (which is for API context)
            addMessage('ai', lang.greeting);
        }

        /**
         * Updates all dynamic UI text (title, placeholder, button) based on the current language.
         */
        function updateUI() {
            const lang = LANGUAGES[currentLanguage];
            appTitle.textContent = lang.title;
            userInput.placeholder = lang.placeholder;
            sendButton.textContent = lang.sendButton;
            loadingText.textContent = lang.loading;
        }

        /**
         * Adds a message bubble to the chat history and scrolls to the bottom.
         */
        function addMessage(sender, text, sources = []) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';

            const messageBubble = document.createElement('div');
            messageBubble.className = sender === 'user' 
                ? 'chat-bubble-user p-4 max-w-3xl break-words whitespace-pre-wrap' 
                : 'chat-bubble-ai p-4 max-w-3xl break-words whitespace-pre-wrap';
            
            if (sender === 'ai') {
                const header = document.createElement('p');
                header.className = 'font-semibold text-blue-600 mb-1';
                header.textContent = `${LANGUAGES[currentLanguage].title}:`;
                messageBubble.appendChild(header);
            }

            const textContent = document.createElement('p');
            textContent.innerHTML = text.replace(/\n/g, '<br>'); // Handle newlines
            messageBubble.appendChild(textContent);

            // Add source citations if available
            if (sender === 'ai' && sources.length > 0) {
                const sourcesList = document.createElement('div');
                sourcesList.className = 'mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500';
                
                // Get the appropriate language for the "Sources" label
                let sourcesLabel = 'Sources';
                if (LANGUAGES[currentLanguage].code === 'Thai') {
                    sourcesLabel = 'à¹à¸«à¸¥à¹ˆà¸‡à¸—à¸µà¹ˆà¸¡à¸²';
                } else if (LANGUAGES[currentLanguage].code === 'Simplified Chinese') {
                    sourcesLabel = 'æ¥æº';
                }

                sourcesList.innerHTML = `<p class="font-medium mb-1">${sourcesLabel}:</p>`;
                
                sources.slice(0, 3).forEach((source, index) => {
                    const sourceLink = document.createElement('a');
                    sourceLink.href = source.uri;
                    sourceLink.target = '_blank';
                    sourceLink.className = 'block hover:text-blue-600 transition duration-150 ease-in-out truncate';
                    sourceLink.textContent = `${index + 1}. ${source.title || source.uri}`;
                    sourcesList.appendChild(sourceLink);
                });

                messageBubble.appendChild(sourcesList);
            }

            messageWrapper.appendChild(messageBubble);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        /**
         * Fetches a response from the Netlify Proxy with exponential backoff for retries.
         */
        async function fetchWithRetry(payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(PROXY_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();

                    if (!response.ok) {
                        // Throw a generic error if the proxy returns a non-200 status
                        throw { message: result.message || `Proxy error ${response.status}`, status: response.status, detail: "PROXY_ERROR" };
                    }

                    // Successful response from proxy: { text, sources }
                    return result; 
                } catch (error) {
                    // Re-throw if it's a proxy/connection error or we've reached max retries
                    if (error.detail === "PROXY_ERROR" || i === retries - 1) {
                        throw error;
                    }
                    
                    // Exponential backoff delay
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Handles the sending of a user query to the AI via the Netlify Function.
         */
        async function sendQuery() {
            const userQuery = userInput.value.trim();
            if (userQuery === "") return;

            addMessage('user', userQuery);
            userInput.value = '';
            
            sendButton.disabled = true;
            userInput.disabled = true;
            loadingModal.classList.remove('hidden');

            // 1. Add user query to history for the conversation context
            chatHistoryArray.push({ role: "user", parts: [{ text: userQuery }] });

            // 2. Prepare payload for the Netlify Proxy
            // The proxy expects chatHistory (for context) and systemPrompt (for persona)
            const lang = LANGUAGES[currentLanguage];
            const payload = {
                chatHistory: chatHistoryArray, 
                systemPrompt: lang.systemPrompt 
            };

            try {
                // 3. Call the Netlify Proxy
                const result = await fetchWithRetry(payload);
                
                // Expect simplified response: { text: string, sources: Array<{uri: string, title: string}> }
                const aiResponseText = result.text || lang.error_general;
                const sources = result.sources || [];

                
                // 4. Update chat history array and display AI message
                chatHistoryArray.push({ role: "model", parts: [{ text: aiResponseText }] });
                addMessage('ai', aiResponseText, sources);

            } catch (error) {
                console.error("Netlify Proxy Error:", error);
                
                // 5. Display generic server error message
                const lang = LANGUAGES[currentLanguage];
                const errorMessage = lang.error_general; 

                addMessage('ai', errorMessage);
                // Remove the last user message from history so the user can retry
                chatHistoryArray.pop();
            } finally {
                // 6. Hide loading and re-enable inputs
                loadingModal.classList.add('hidden');
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        // --- Event Listeners and Init ---

        languageSelect.addEventListener('change', (event) => {
            currentLanguage = event.target.value;
            updateUI();
            
            // Clear history and reset context for the new language conversation
            chatHistoryArray = []; 
            displayInitialGreeting(); 
        });

        sendButton.addEventListener('click', sendQuery);

        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !sendButton.disabled) {
                sendQuery();
            }
        });

        window.onload = () => {
            updateUI();
            displayInitialGreeting();
            userInput.focus();
        };

    </script>
</body>
</html>